<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Mapbox GL JS map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.11.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.11.1/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #summary {
            height: 20%;
         
            background-color: #f8f9fa;
           
            padding: 1rem;
            text-align: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        #map {
            flex: 1;
            
            width: 100%;
        }

        #menu {
            background: #fff;
            position: absolute;
            z-index: 1;
            top: 10px;
            left: 10px;
            border-radius: 3px;
            width: 120px;
            border: 1px solid rgba(0, 0, 0, 0.4);
            font-family: 'Open Sans', sans-serif;
        }

        #menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        #menu a:last-child {
            border: none;
        }

        #menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
        }

        #menu a.active {
            background-color: #3887be;
            color: #ffffff;
        }

        #menu a.active:hover {
            background: #3074a4;
        }
        .mapboxgl-ctrl {
            margin-top: 10%;
        }


    </style>
</head>

<body>
    <nav id="menu"></nav>
    <div id="map"></div>

    <div id="summary">
        <h3>Feature Information</h3>
        <p>Click on the map to view data.</p>
    </div>

    <script src="/js/layers.js"></script>
</body>

</html>


<!-- <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Climate Map with AI Assistant</title>
    
   
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    
    <style>
        #map {
            height: 600px;
            width: 100%;
            margin: 20px 0;
        }

        .summary-box {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }

        .layer-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .layer-toggle {
            display: block;
            margin: 5px 0;
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
        }

        .ai-chatbot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .chat-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-content {
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            position: relative;
        }

        .loading-spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        #ai-response {
            height: 100%;
            overflow-y: auto;
        }

        .ai-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="layer-controls">
        <button class="layer-toggle" id="toggleWildfires">Wildfires</button>
        <button class="layer-toggle" id="togglePrecipitation">Precipitation</button>
        <button class="layer-toggle" id="toggleSatellite">Satellite View</button>
    </div>

    <div id="map"></div>
    <div class="summary-box" id="summary">
        <h3>BC Climate Data</h3>
        <p>Toggle AI assistant to analyze locations</p>
    </div>

    <button class="ai-toggle" id="toggleAI">üó®Ô∏è Show AI Assistant</button>
    <div class="ai-chatbot">
        <div class="chat-header">
            <h4>üå≤ BC Environment Assistant</h4>
            <button id="closeAI" style="background: none; border: none; cursor: pointer; font-size: 1.2em;">√ó</button>
        </div>
        <div class="chat-content">
            <div class="loading-spinner"></div>
            <div id="ai-response">
                <p>AI assistant ready. Click locations on the map to analyze.</p>
            </div>
        </div>
    </div>

    <script>
        //mapbox config
        mapboxgl.config.REQUIRE_ACCESS_TOKEN = true;
        mapboxgl.config.SKIP_TELEMETRY = true;
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2F1Y2VyIiwiYSI6ImNtOXl3eHk2ZTFqYjIyanEwcGYyaXhrNWIifQ.-tyNISOOUA6SPxqZc4tSfQ';
        const OPENAI_API_KEY = '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';

        // Initialize Map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v12',
            center: [-123.1207, 49.2827],
            zoom: 8
        });

        // geojson climate data
        map.on('load', () => {
            map.addSource('bc-wildfires', {
                type: 'geojson',
                data: 'https://corsproxy.io/?url=https://services6.arcgis.com/ubm4tcTYICKBpist/arcgis/rest/services/Active_Wildfires_Public_View/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson'
            });

            map.addLayer({
                id: 'wildfires',
                type: 'circle',
                source: 'bc-wildfires',
                paint: {
                    'circle-radius': 8,
                    'circle-color': '#FF4500',
                    'circle-opacity': 0.7
                },
                filter: ['==', '$type', 'Point']
            });

            map.addSource('precipitation', {
                type: 'geojson',
                data: 'https://api.weather.gc.ca/collections/climate-daily/items/2400572.2009.6.18?f=json'
            });

            map.addLayer({
                id: '2400572.2009.6.18',
                type: 'Point',
                source: 'precipitation',
                layout: { visibility: 'none' },
                paint: {
                    'fill-color': '#1f78b4',
                    'fill-opacity': 0.3
                }
            });
        });

        // layer toggling
        document.getElementById('toggleWildfires').addEventListener('click', () => {
            const visibility = map.getLayoutProperty('wildfires', 'visibility');
            map.setLayoutProperty('wildfires', 'visibility', visibility === 'visible' ? 'none' : 'visible');
        });

        document.getElementById('togglePrecipitation').addEventListener('click', () => {
            const visibility = map.getLayoutProperty('precipitation', 'visibility');
            map.setLayoutProperty('precipitation', 'visibility', visibility === 'visible' ? 'none' : 'visible');
        });

        document.getElementById('toggleSatellite').addEventListener('click', () => {
            const currentStyle = map.getStyle();
            const newStyle = currentStyle.sprite === 'mapbox://sprites/mapbox/satellite-v9' 
                ? 'mapbox://styles/mapbox/outdoors-v12' 
                : 'mapbox://styles/mapbox/satellite-v9';
            map.setStyle(newStyle);
        });

        // ai functionality
        let isAIVisible = false;
        const chatbot = document.querySelector('.ai-chatbot');
        const aiToggle = document.getElementById('toggleAI');
        const spinner = document.querySelector('.loading-spinner');
        const aiResponse = document.getElementById('ai-response');

        function toggleAIAssistant() {
            isAIVisible = !isAIVisible;
            chatbot.style.display = isAIVisible ? 'block' : 'none';
            aiToggle.textContent = isAIVisible ? 'üó®Ô∏è Hide AI Assistant' : 'üó®Ô∏è Show AI Assistant';
        }

        aiToggle.addEventListener('click', toggleAIAssistant);
        document.getElementById('closeAI').addEventListener('click', toggleAIAssistant);

        // AI analysis
        async function analyzeLocation(lat, lng) {
            if (!spinner || !aiResponse) {
                console.error('UI elements missing');
                return;
            }

            try {
                spinner.style.display = 'block';
                aiResponse.innerHTML = '';

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: [{
                            role: "user",
                            content: `Analyze ${lat}, ${lng} in BC including:
                                    - Geographic features
                                    - Climate patterns
                                    - Ecological characteristics
                                    - Environmental risks
                                    - Conservation status
                                    Use HTML paragraphs with bold headings.`
                        }]
                    })
                });

                const data = await response.json();
                spinner.style.display = 'none';
                
                if (data.choices?.[0]?.message?.content) {
                    aiResponse.innerHTML = data.choices[0].message.content;
                } else {
                    aiResponse.innerHTML = '<p>Error processing response</p>';
                }
            } catch (error) {
                console.error('AI Error:', error);
                spinner.style.display = 'none';
                aiResponse.innerHTML = '<p>Error fetching analysis. Please try again.</p>';
            }
        }

        // map interactions 
        map.on('click', async (e) => {
            if (!isAIVisible) return;
            
            const { lng, lat } = e.lngLat;
            
            document.getElementById('summary').innerHTML = `
                <h3>Selected Location</h3>
                <p>Latitude: ${lat.toFixed(4)}</p>
                <p>Longitude: ${lng.toFixed(4)}</p>
                <p>Analyzing location...</p>
            `;

            await analyzeLocation(lat, lng);
        });

        // wildfire click handler
        map.on('click', 'wildfires', (e) => {
            const props = e.features[0].properties;
            new mapboxgl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(`
                    <h3>üî• Wildfire Alert</h3>
                    <p><strong>ID:</strong> ${props.FIRE_ID}</p>
                    <p><strong>Status:</strong> ${props.FIRE_STATUS}</p>
                    <p><strong>Size:</strong> ${props.CURRENT_SIZE} hectares</p>
                    <p><strong>Discovered:</strong> ${new Date(props.FIRE_DISCOVERY_DATE).toLocaleDateString()}</p>
                `)
                .addTo(map);
            e.originalEvent.stopPropagation();
        });

        // map controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-left');
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: false },
            trackUserLocation: true
        }), 'bottom-left');
    </script>
    <script src="/server.js"></script>
</body> -->
